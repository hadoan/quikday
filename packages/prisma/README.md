**Prisma Package — Architecture & Replication Guide**

- Centralized Prisma client, schema, and tooling for the monorepo.
- Provides migrations, seeds, zod schema generation, enum exports, and safe selects.
- Designed for reuse: import `@quillsocial/prisma` across apps for a single client instance and shared types.

**Directory Layout**
- `packages/prisma/schema.prisma`: Datasource, generators, models, enums.
- `packages/prisma/migrations/`: SQL migrations created by Prisma Migrate.
- `packages/prisma/index.ts`: Singleton Prisma client, `customPrisma`, and re‑exports of selects.
- `packages/prisma/client/`: Re‑exports generated Prisma client from `node_modules/.prisma/client` for consistent import paths.
- `packages/prisma/selects/`: Typed `Prisma.validator` selects to avoid leaking sensitive fields.
- `packages/prisma/zod/`: Generated by `zod-prisma` generator.
- `packages/prisma/zod-utils.ts`: Shared zod helpers (transforms, denullish, schemas).
- `packages/prisma/enums/`: Generated enum constants and types from Prisma enums.
- `packages/prisma/seed.ts`: Minimal seed (e.g., admin user).
- `packages/prisma/seed-app-store.ts`: Legacy/deprecated app-store seeding used for E2E tests only.

**Schema & Generators**
- `schema.prisma` config:
  - `datasource db`: PostgreSQL, `url = env("DATABASE_URL")`.
  - `generator client`: Prisma Client JS with `views` preview, targeting `native` and `linux-musl-openssl-3.0.x`.
  - `generator zod`: `zod-prisma` outputs to `./zod` and imports helpers from `./zod-utils`.
  - Models include users/teams/memberships, app store models, social posting, engagement tracking (X/Threads), notifications, pillars/ideas/outlines, etc.

Notes:
- Enums are exposed as TS constants/types in `enums/` for ergonomic import. These should be generated from schema enums.
- If you add/modify enums, regenerate the enums artifact (see “Enum Generation” below).

**Client Initialization**
- `index.ts` exports a process‑wide Prisma client singleton, with helpful behavior:
  - Warns clearly if `DATABASE_URL` is missing.
  - Provides a Proxy that throws on any access if the URL is not set (fail-fast).
  - Enables logging in debug via `NEXT_PUBLIC_DEBUG`.
  - Exposes `customPrisma(options)` to spin up a temporary client with extra options (e.g. log levels) without affecting the singleton.
- Re‑exports everything from `./selects` for centralized, safe selects.

Usage examples:
- `import prisma from "@quillsocial/prisma"`
- `import { userSelect, safeCredentialSelect } from "@quillsocial/prisma"`
- `import type { PostStatus } from "@quillsocial/prisma/enums"`

**Safe Selects Pattern**
- The `selects/` directory centralizes reusable, type‑safe selections:
  - `selects/app.ts` → `safeAppSelect` excludes secrets like `keys`.
  - `selects/credential.ts` → `safeCredentialSelect` excludes sensitive `key` JSON.
  - `selects/user.ts` → `availabilityUserSelect`, `baseUserSelect`, `userSelect` patterns.
- Benefit: Prevent accidental leakage of secrets in API responses and keep selection shapes consistent across the app.

**Zod Integration**
- `generator zod` in `schema.prisma` creates zod schemas per model in `./zod/`.
- `zod-utils.ts` contains:
  - Transforms (e.g., ISO string → Date, string/number coercions),
  - `denullish` helpers to strip nullable/optional wrappers from nested zod types,
  - App‑specific schemas like `teamMetadataSchema`, `userMetadata`.
- Use generated zod schemas for input validation and runtime safety in APIs.

**Enum Generation**
- `enums/index.ts` exports constants and TypeScript types mirroring Prisma enums.
- The file header indicates it’s generated by a custom Prisma generator.
- To wire this up in another project, add a generator block to your `schema.prisma`:
  
  `generator enums {`
  `  provider = "node ./packages/prisma/enum-generator-runner.js"`
  `  output   = "./packages/prisma/enums/index.ts"`
  `}`
  
- Or run the generator programmatically (Node) after `prisma generate` finishes.

**Seeding**
- Primary seed: `seed.ts` (creates an admin user with hashed password, marks email verified, etc.).
- App store seed: `seed-app-store.ts` is deprecated and only used for E2E tests; it upserts entries in the `App` model and rewrites `Credential.appId` based on `type` matches to keep credentials linked.
- Enable Prisma’s seed hook in `packages/prisma/package.json`:
  - `"prisma": { "seed": "ts-node --transpile-only ./seed.ts" }`
- Seed scripts expect `DATABASE_URL` to be defined.

**Scripts & Workflows**
- Package scripts (see `packages/prisma/package.json`):
  - `generate-schemas`: `prisma generate && prisma format`
  - `db-migrate`: `prisma migrate dev` (creates migrations during development)
  - `db-deploy`: `prisma migrate deploy` (applies existing migrations in CI/prod)
  - `db-studio`: `prisma studio` (browser UI)
  - `db-seed`: `prisma db seed` (runs `packages/prisma/seed.ts`)
  - `seed-app-store`: `ts-node --transpile-only ./seed-app-store.ts` (deprecated)

Note:
- Some convenience scripts referenced elsewhere (e.g., `db-reset`, `db-up`, `db-nuke`) are not defined in this package; wire these in your own repo as needed or call Prisma commands directly.

**Environment Variables**
- Required: `DATABASE_URL` (PostgreSQL connection string) for both `prisma` CLI and `PrismaClient`.
- Other optional vars used by seeds (if you reuse `seed-app-store.ts`):
  - Google/Twitter/Threads/Instagram/etc. app credentials.
  - Stripe keys, Zapier invite link, Vital keys, etc.
- Best practice: Define per‑env files at repo root (e.g., `.env.development`, `.env.production`) and ensure CLI processes inherit them.

**Replicating in Another Project**
- 1) Install dependencies
  - `prisma`, `@prisma/client`, `ts-node`, `zod`, `zod-prisma`.
  - Optionally `@prisma/generator-helper` if you want custom enum generation.

- 2) Create schema and generators
  - `schema.prisma` with your datasource and:
    - `generator client { provider = "prisma-client-js" }`
    - `generator zod { provider = "zod-prisma" output = "./zod" imports = "./zod-utils" }`
    - Optional: add `generator enums { provider = "node ./enum-generator-runner.js" output = "./enums/index.ts" }`

- 3) Add client bootstrap
  - Create `index.ts` exporting a singleton `PrismaClient` and `customPrisma(options)`.
  - Include the fail‑fast proxy for missing `DATABASE_URL` and optional debug logging.

- 4) Add selects
  - Create `selects/` and define reusable selections via `Prisma.validator`.
  - Export a barrel in `selects/index.ts` and re‑export it from package root.

- 5) Add zod utilities
  - Add `zod-utils.ts` with any transforms and shared app schemas you need.
  - Ensure `generator zod` `imports = "./zod-utils"` can resolve.

- 6) Seed data
  - Add minimal `seed.ts` and configure `"prisma": { "seed": "ts-node --transpile-only ./seed.ts" }`.
  - Only add `seed-app-store.ts` if you have a similar App catalog need.

- 7) Migrate & generate
  - `prisma migrate dev` (create migrations) → commit `migrations/`.
  - `prisma generate` (produces Prisma Client + zod + enums if configured).

- 8) Import from other packages
  - Use `import prisma from "@your-scope/prisma"` everywhere to ensure one client instance.
  - Import selects from `@your-scope/prisma` and enums from `@your-scope/prisma/enums`.

**Common Commands**
- Initialize DB locally: `yarn workspace @quillsocial/prisma prisma migrate dev`
- Apply migrations in CI/prod: `yarn workspace @quillsocial/prisma prisma migrate deploy`
- Generate client + zod: `yarn workspace @quillsocial/prisma prisma generate`
- Open studio: `yarn workspace @quillsocial/prisma prisma studio`
- Seed: `yarn workspace @quillsocial/prisma prisma db seed`

**Caveats & Tips**
- Ensure only one Prisma Client instance is used across the monorepo (import from this package, not raw `@prisma/client`).
- Keep secrets out of selects and public APIs by default; prefer safe selects.
- If you change enums or models, re‑run `prisma generate` (and enum generator if using the custom block) and commit outputs if your workflow requires it.
- `seed-app-store.ts` is deprecated; if you reuse it, treat it as test tooling and update to your models/keys.

**Example: Using a Safe Select**
- Fetch a list of apps without leaking keys:
  - `const apps = await prisma.app.findMany({ select: safeAppSelect });`

**Example: Adding a Model**
- Edit `schema.prisma` and add your model + enums.
- Run `prisma migrate dev` → creates a new migration.
- Run `prisma generate` → updates client and zod schemas (and enums if configured).
- Add/select helpers and any seed data as needed.

**Support**
- Prisma docs: `https://www.prisma.io/docs`
- zod-prisma: `https://github.com/omar-dulaimi/zod-prisma`
- Prisma Generators: `@prisma/generator-helper` for custom codegen.

